#!/usr/bin/env bash
# Create a new version: update __version__.py, commit, tag and optionally push.
# Usage: ./create_new_version 2.0.4 [--no-push] [--sign]

set -euo pipefail

usage() {
  cat <<EOF
Usage: $0 VERSION [--no-push] [--sign] [--dry-run]

Example:
  $0 2.0.4         # update __version__.py, commit, tag v2.0.4, push commit+tag
  $0 2.0.4 --no-push  # do everything except pushing to remote
  $0 2.0.4 --sign     # create a signed tag (gpg) if available
  $0 2.0.4 --dry-run  # print actions without executing

Note: Version is now managed dynamically from vyte/__version__.py
EOF
}

if [ "$#" -lt 1 ]; then
  usage
  exit 2
fi

VERSION="$1"
shift || true

NO_PUSH=0
SIGN_TAG=0
DRY_RUN=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-push) NO_PUSH=1 ;;
    --sign) SIGN_TAG=1 ;;
    --dry-run) DRY_RUN=1 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1"; usage; exit 2 ;;
  esac
  shift
done

if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([.-].*)?$'; then
  echo "Version must look like MAJOR.MINOR.PATCH, got: $VERSION"
  exit 2
fi

# Get the repository root directory
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
VERSION_FILE="$REPO_ROOT/vyte/__version__.py"

if [ ! -f "$VERSION_FILE" ]; then
  echo "Error: $VERSION_FILE not found"
  exit 2
fi

# Change to repository root for git operations
cd "$REPO_ROOT"

# Ensure git working tree is clean
if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
  echo "Git working tree is not clean. Please commit or stash changes first."
  git status --porcelain
  exit 1
fi

echo "Preparing to bump version to $VERSION"

# Parse version into tuple format
IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
MAJOR="${VERSION_PARTS[0]}"
MINOR="${VERSION_PARTS[1]}"
PATCH="${VERSION_PARTS[2]:-0}"

BACKUP="${VERSION_FILE}.bak"

echo "Backing up $VERSION_FILE -> $BACKUP"
cp "$VERSION_FILE" "$BACKUP"

echo "Updating version in $VERSION_FILE"

if [ "$DRY_RUN" -eq 1 ]; then
  echo "[DRY RUN] Would update VERSION to ($MAJOR, $MINOR, $PATCH)"
else
  cat > "$VERSION_FILE" <<EOF
# vyte/__version__.py
"""Version information"""

VERSION = ($MAJOR, $MINOR, $PATCH)
__version__ = '.'.join(map(str, VERSION))
EOF
  echo "✓ Updated $VERSION_FILE to version $VERSION"
fi

# Update CHANGELOG.md with new version
CHANGELOG="$REPO_ROOT/CHANGELOG.md"
if [ -f "$CHANGELOG" ]; then
  TODAY=$(date +%Y-%m-%d)
  echo "Updating CHANGELOG.md"

  if [ "$DRY_RUN" -eq 1 ]; then
    echo "[DRY RUN] Would update CHANGELOG.md with version $VERSION"
  else
    # Insert new version section after the first ## heading
    awk -v ver="$VERSION" -v date="$TODAY" '
      !done && /^## \[/ {
        print "## [" ver "] - " date
        print ""
        print "### Added"
        print "- "
        print ""
        print "### Changed"
        print "- "
        print ""
        print "### Fixed"
        print "- "
        print ""
        done=1
      }
      { print }
    ' "$CHANGELOG" > "${CHANGELOG}.tmp"
    mv "${CHANGELOG}.tmp" "$CHANGELOG"
    echo "✓ Updated CHANGELOG.md"
  fi
fi

GIT_COMMIT_MSG="Bump version to $VERSION"

echo "Staging files"
if [ "$DRY_RUN" -eq 1 ]; then
  echo "DRY RUN: git add vyte/__version__.py CHANGELOG.md"
else
  git add vyte/__version__.py
  [ -f "$CHANGELOG" ] && git add CHANGELOG.md
fi

echo "Creating commit"
if [ "$DRY_RUN" -eq 1 ]; then
  echo "DRY RUN: git commit -m \"$GIT_COMMIT_MSG\""
else
  git commit -m "$GIT_COMMIT_MSG"
fi

TAG_NAME="v$VERSION"
TAG_MSG="Release $TAG_NAME"

echo "Creating tag $TAG_NAME"
if [ "$DRY_RUN" -eq 1 ]; then
  if [ "$SIGN_TAG" -eq 1 ]; then
    echo "DRY RUN: git tag -s $TAG_NAME -m \"$TAG_MSG\""
  else
    echo "DRY RUN: git tag -a $TAG_NAME -m \"$TAG_MSG\""
  fi
else
  if [ "$SIGN_TAG" -eq 1 ]; then
    git tag -s "$TAG_NAME" -m "$TAG_MSG"
  else
    git tag -a "$TAG_NAME" -m "$TAG_MSG"
  fi
fi

if [ "$NO_PUSH" -eq 1 ]; then
  echo "--no-push given: skipping git push"
  echo "Done. Remember to push when ready: git push origin HEAD && git push origin $TAG_NAME"
  exit 0
fi

echo "Pushing commit and tag to origin"
if [ "$DRY_RUN" -eq 1 ]; then
  echo "DRY RUN: git push origin HEAD"
  echo "DRY RUN: git push origin $TAG_NAME"
else
  git push origin HEAD
  git push origin "$TAG_NAME"
fi

echo "Done. Version bumped to $VERSION and tag $TAG_NAME created/pushed."
